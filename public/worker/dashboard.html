<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>FIXALL - Worker Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root {
    --primary: #6c5ce7;
    --primary-dark: #5643d0;
    --bg: #050412;
    --card-bg: rgba(14,13,30,0.96);
    --card-border: rgba(130,120,255,0.35);
    --text-main: #ffffff;
    --text-soft: #c7c9e6;
    --green: #00d98b;
    --red: #ff7675;
}

/* GENERAL */
* { box-sizing: border-box; }

body {
    margin: 0;
    background: radial-gradient(circle at top, #32215f 0, #02010b 55%, #000 100%);
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    color: var(--text-main);
    padding-bottom: 72px;
}

/* HEADER */
.header {
    padding: 18px 18px 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.brand {
    display: flex;
    align-items: center;
    gap: 8px;
}
.brand-logo {
    width: 34px;
    height: 34px;
    border-radius: 12px;
    background: radial-gradient(circle at 30% 20%, #a29bfe, #6c5ce7);
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:18px;
    font-weight:900;
    box-shadow:0 6px 16px rgba(108,92,231,0.8);
}
.brand-txt { display:flex; flex-direction:column; }
.brand-txt .t1 {
    font-size:14px;
    font-weight:800;
    letter-spacing:0.08em;
}
.brand-txt .t2 {
    font-size:11px;
    color:var(--text-soft);
}
.worker-chip {
    font-size:11px;
    padding:6px 10px;
    border-radius:999px;
    background:rgba(255,255,255,0.05);
    border:1px solid rgba(255,255,255,0.12);
}

/* FULLSCREEN STATUS OVERLAY (OFFLINE) */
.status-overlay {
    position: fixed;
    inset: 0;
    background: radial-gradient(circle at top, #2f225f 0%, #050413 50%, #02010a 100%);
    backdrop-filter: blur(16px);
    display: none; /* flex when visible */
    align-items: center;
    justify-content: center;
    z-index: 50;
}
.status-card {
    width: 90%;
    max-width: 420px;
    padding: 28px 22px 24px;
    border-radius: 22px;
    background: rgba(10,10,30,0.9);
    border: 1px solid rgba(255,255,255,0.16);
    box-shadow: 0 16px 40px rgba(0,0,0,0.7);
    text-align: center;
}
.status-badge {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 6px 12px;
    border-radius: 999px;
    font-size: 12px;
    border: 1px solid rgba(255,255,255,0.18);
    margin-bottom: 14px;
}
.status-dot-big {
    width: 12px;
    height: 12px;
    border-radius: 999px;
}
.status-title {
    font-size: 22px;
    font-weight: 800;
}
.status-subtitle {
    margin-top: 6px;
    font-size: 14px;
    color: var(--text-soft);
}
.status-jobs {
    margin-top: 14px;
    font-size: 13px;
    color: #dfe6ff;
}
.status-btn {
    margin-top: 22px;
    width: 100%;
    padding: 15px;
    border-radius: 18px;
    border: none;
    font-size: 17px;
    font-weight: 800;
    cursor: pointer;
    background: linear-gradient(135deg, #6c5ce7, #9b59b6);
    color: white;
    box-shadow: 0 14px 30px rgba(108,92,231,0.7);
}

/* SMALL DIALOG OVERLAY (GO OFFLINE CONFIRM) */
.dialog-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.55);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 60;
}
.dialog-card {
    width: 88%;
    max-width: 380px;
    background: rgba(12,12,30,0.96);
    border-radius: 20px;
    border: 1px solid rgba(255,255,255,0.16);
    padding: 20px 18px 16px;
    box-shadow: 0 14px 34px rgba(0,0,0,0.8);
}
.dialog-title {
    font-size: 17px;
    font-weight: 800;
    margin-bottom: 6px;
}
.dialog-text {
    font-size: 14px;
    color: var(--text-soft);
    margin-bottom: 14px;
}
.dialog-actions {
    display: flex;
    flex-direction: column;
    gap: 8px;
}
.dialog-btn-primary {
    width: 100%;
    padding: 11px;
    border-radius: 14px;
    border: none;
    background: linear-gradient(135deg,#6c5ce7,#9b59b6);
    color:white;
    font-weight:700;
    cursor:pointer;
}
.dialog-btn-danger {
    width: 100%;
    padding: 11px;
    border-radius: 14px;
    border: 1px solid rgba(255,118,117,0.7);
    background: rgba(255,118,117,0.08);
    color:#ff7675;
    font-weight:700;
    cursor:pointer;
}
.dialog-btn-ghost {
    width: 100%;
    padding: 10px;
    border-radius: 14px;
    border: 1px solid rgba(255,255,255,0.15);
    background: rgba(255,255,255,0.03);
    color: var(--text-soft);
    font-weight:600;
    cursor:pointer;
}

/* TABS */
.tabs {
    margin: 0 18px 10px;
    background: rgba(10,10,28,0.95);
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,0.06);
    display: flex;
    padding: 4px;
}
.tab-btn {
    flex: 1;
    padding: 8px 0;
    border-radius: 999px;
    font-size: 12px;
    text-align: center;
    cursor: pointer;
    color: var(--text-soft);
}
.tab-btn-active {
    background: linear-gradient(135deg, #6c5ce7, #9b59b6);
    color: #fff;
    font-weight: 700;
    box-shadow: 0 6px 14px rgba(108,92,231,0.7);
}

/* TITLES */
.section-title {
    margin: 6px 18px 4px;
    font-size: 13px;
    letter-spacing: 0.13em;
    color: rgba(199,201,230,0.85);
}

/* JOB CARD */
.job-card {
    margin: 8px 18px;
    padding: 14px 14px 12px;
    border-radius: 18px;
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    box-shadow: 0 12px 26px rgba(0,0,0,0.7);
}
.job-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.job-title-block { display: flex; flex-direction: column; }
.job-title { font-size: 15px; font-weight: 700; }
.job-client { font-size: 11px; color: var(--text-soft); }
.job-price { font-size: 16px; font-weight: 800; color: var(--green); }
.job-body {
    margin-top: 8px;
    font-size: 12px;
    color: var(--text-soft);
}
.job-row { margin-top: 4px; }
.job-row b { color: #f5f6fa; }
.job-footer {
    margin-top: 10px;
    display: flex;
    flex-direction: column;
    gap: 6px;
}
.action-btn-main {
    width: 100%;
    background: linear-gradient(135deg, #6c5ce7, #9b59b6);
    border-radius: 999px;
    border: none;
    padding: 9px 0;
    font-size: 13px;
    font-weight: 700;
    color: #fff;
    cursor: pointer;
}
.action-btn-secondary {
    width: 100%;
    background: rgba(255,255,255,0.04);
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,0.08);
    padding: 8px 0;
    font-size: 12px;
    color: var(--text-soft);
    cursor: pointer;
}

/* STATUS PILLS */
.status-pill {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    margin-top: 8px;
    padding: 4px 10px;
    border-radius: 999px;
    font-size: 11px;
    font-weight: 700;
}
.status-dot {
    width: 8px;
    height: 8px;
    border-radius: 999px;
    background: #fff;
}
.s-pending   { background:rgba(99,110,114,0.4); color:#dfe6e9; }
.s-accepted  { background:rgba(108,92,231,0.4); color:#dfe6ff; }
.s-on_the_way{ background:rgba(253,203,110,0.4); color:#ffeaa7; }
.s-arrived   { background:rgba(0,151,230,0.4); color:#aee9ff; }
.s-working   { background:rgba(232,67,147,0.4); color:#ffb6e3; }
.s-complete  { background:rgba(0,184,148,0.4); color:#a3ffdf; }
.s-cancelled { background:rgba(214,48,49,0.4); color:#ffb3b3; }

/* EMPTY */
.empty-message {
    margin: 40px 18px;
    text-align: center;
    font-size: 13px;
    color: var(--text-soft);
}

/* FLOATING GO OFFLINE BUTTON */
.fab-offline {
    position: fixed;
    bottom: 76px;
    left: 50%;
    transform: translateX(-50%);
    padding: 11px 22px;
    border-radius: 999px;
    border: none;
    font-size: 13px;
    font-weight: 700;
    background: rgba(255,118,117,0.2);
    color: #ffecec;
    box-shadow: 0 10px 24px rgba(0,0,0,0.7);
    display: none;
    z-index: 40;
    cursor: pointer;
}

/* NAV BAR */
.bottom-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgba(8,8,24,0.96);
    backdrop-filter: blur(14px);
    border-top: 1px solid rgba(255,255,255,0.08);
    display: flex;
    justify-content: space-around;
    padding: 6px 0 8px;
}
.nav-btn {
    text-align: center;
    font-size: 11px;
    color: var(--text-soft);
    text-decoration: none;
}
.nav-btn span {
    display:block;
    font-size:20px;
    margin-bottom:2px;
}
.nav-btn-active {
    color: #a29bfe;
    font-weight: 700;
}
</style>

<script type="module">
import { supabase } from "/js/supabase.js";

document.addEventListener("DOMContentLoaded", async () => {


    const w = JSON.parse(localStorage.getItem("fixall_user"));
    if (!w || w.role !== "worker") {
        location.href = "/login.html";
        return;
    }

    if (!w.profile_image) {
        alert("You must upload a profile picture before accepting jobs.");
        location.href = "/worker/edit-profile.html";
        return;
    }

    document.getElementById("workerNameChip").textContent = w.full_name;

    const availableList = document.getElementById("availableJobs");
    const myJobsList = document.getElementById("myJobs");
    const completedList = document.getElementById("completedJobs");

    const tabAvailable = document.getElementById("tabAvailable");
    const tabMyJobs = document.getElementById("tabMyJobs");
    const tabCompleted = document.getElementById("tabCompleted");

    const statusOverlay = document.getElementById("statusOverlay");
    const overlayStatusText = document.getElementById("overlayStatusText");
    const overlayJobsText = document.getElementById("overlayJobsText");
    const btnGoOnline = document.getElementById("btnGoOnline");

    const fabOffline = document.getElementById("fabOffline");

    const dialogOverlay = document.getElementById("dialogOverlay");
    const dialogTitle = document.getElementById("dialogTitle");
    const dialogText = document.getElementById("dialogText");
    const dialogPrimary = document.getElementById("dialogPrimary");
    const dialogDanger = document.getElementById("dialogDanger");
    const dialogGhost = document.getElementById("dialogGhost");

    let activeJobCache = null;

    /* ---------------------------
       WORKER STATUS
    ----------------------------*/

    async function getWorkerStatus() {
        const { data, error } = await supabase
            .from("worker_status")
            .select("*")
            .eq("worker_id", w.id)
            .maybeSingle();

        if (error) return null;
        return data;
    }

    async function ensureWorkerStatusRow() {
        const row = await getWorkerStatus();
        if (!row) {
            await supabase.from("worker_status").insert({
                worker_id: w.id,
                is_online: false,
                last_online: new Date().toISOString()
            });
        }
    }

    async function setWorkerOnlineState(isOnline) {
        await supabase
            .from("worker_status")
            .update({
                is_online: isOnline,
                last_online: new Date().toISOString()
            })
            .eq("worker_id", w.id);
    }

    /* ---------------------------
       ACTIVE JOB
    ----------------------------*/
    async function getActiveJob() {
        const { data } = await supabase
            .from("jobs")
            .select("*")
            .eq("worker_id", w.id)
            .in("status", ["accepted","on_the_way","arrived","working"])
            .order("created_at", { ascending: false })
            .limit(1)
            .maybeSingle();

        return data;
    }

    /* ---------------------------
       STATUS PILL
    ----------------------------*/
    function statusPill(status) {
        let cls = "s-pending";
        if (status === "accepted") cls = "s-accepted";
        if (status === "on_the_way") cls = "s-on_the_way";
        if (status === "arrived") cls = "s-arrived";
        if (status === "working") cls = "s-working";
        if (status === "complete") cls = "s-complete";
        if (status === "cancelled") cls = "s-cancelled";
        return `<span class="status-pill ${cls}"><span class="status-dot"></span>${status}</span>`;
    }

    function mapsLink(job) {
        const q = encodeURIComponent(`${job.street}, ${job.city}, ${job.state} ${job.zipcode}`);
        return `https://www.google.com/maps/search/?api=1&query=${q}`;
    }

    /* ---------------------------
       UPDATE OVERLAY
    ----------------------------*/
    async function updateOverlayAndFab() {
        await ensureWorkerStatusRow();
        const statusRow = await getWorkerStatus();
        const isOnline = statusRow?.is_online;

        if (isOnline) {
            overlayStatusText.textContent = "You are currently ONLINE";
            statusOverlay.style.display = "none";
            fabOffline.style.display = "block";
        } else {
            overlayStatusText.textContent = "You are currently OFFLINE";
            statusOverlay.style.display = "flex";
            fabOffline.style.display = "none";
        }
    }

    /* ---------------------------
       LOAD AVAILABLE
       + MAPA INSERTADO AQUÍ
    ----------------------------*/
    async function loadAvailable() {
        const status = await getWorkerStatus();
        availableList.innerHTML = "";

        if (!status?.is_online) {
            availableList.innerHTML = `<div class="empty-message">
                You are <b>offline</b>. Go online to view jobs.
            </div>`;
            return;
        }

        const fiveMinutesAgo = new Date(Date.now() - 300000).toISOString();

        const { data: jobs } = await supabase
            .from("jobs")
            .select("*")
            .is("worker_id", null)
            .eq("status", "pending")
            .gte("created_at", fiveMinutesAgo)
            .order("created_at", { ascending: true });

        if (!jobs?.length) {
            availableList.innerHTML = `<div class="empty-message">No available jobs.</div>`;
            return;
        }

        jobs.forEach(job => {
            const price = job.price?.toFixed?.(2) || "0.00";

            const div = document.createElement("div");
            div.className = "job-card";
            div.innerHTML = `
                <div class="job-header">
                    <div class="job-title-block">
                        <div class="job-title">${job.title}</div>
                        <div class="job-client">Client: ${job.client_name}</div>
                    </div>
                    <div class="job-price">$${price}</div>
                </div>

                <div class="job-body">
                    <div class="job-row"><b>Category:</b> ${job.category}</div>

                    <div class="job-row"><b>Address:</b> ${job.street}, ${job.city}, ${job.state} ${job.zipcode}</div>

                    <!-- MAPA AQUÍ -->
                    <iframe
                        width="100%"
                        height="180"
                        style="border:0; border-radius:12px; margin-top:8px;"
                        loading="lazy"
                        allowfullscreen
                        src="https://maps.google.com/maps?q=${encodeURIComponent(job.street + ', ' + job.city + ', ' + job.state + ' ' + job.zipcode)}&t=&z=15&ie=UTF8&iwloc=&output=embed">
                    </iframe>

                    <div class="job-row"><b>Payment:</b> ${job.payment_methods}</div>
                    <div class="job-row"><b>Details:</b> ${job.description}</div>
                    ${statusPill(job.status)}
                </div>

                <div class="job-footer">
                    <button class="action-btn-main">Accept Job</button>
                    <button class="action-btn-secondary">Open in Maps</button>
                </div>
            `;

            div.querySelector(".action-btn-main").onclick = async () => {
                const active = await getActiveJob();

                if (active) return alert("Finish your current job first.");

                await supabase.from("jobs")
                    .update({
                        worker_id: w.id,
                        worker_name: w.full_name,
                        worker_phone: w.phone,
                        worker_photo: w.profile_image,
                        status: "accepted"
                    })
                    .eq("id", job.id)
                    .is("worker_id", null);

                loadAll();
            };

            div.querySelector(".action-btn-secondary").onclick = () => {
                window.open(mapsLink(job), "_blank");
            };

            availableList.appendChild(div);
        });
    }

    /* ---------------------------
       UPDATE STATUS
    ----------------------------*/
    async function updateStatus(jobId, newStatus) {
        await supabase.from("jobs")
            .update({ status: newStatus })
            .eq("id", jobId)
            .eq("worker_id", w.id);

        loadAll();
    }

    /* ---------------------------
       LOAD MY JOBS
       + MAPAS AQUÍ TAMBIÉN
    ----------------------------*/
    async function loadMyJobs() {
        const { data: jobs } = await supabase
            .from("jobs")
            .select("*")
            .eq("worker_id", w.id)
            .not("status", "in", "('complete','cancelled')")
            .order("created_at", { ascending:false });

        myJobsList.innerHTML = "";

        if (!jobs?.length) {
            myJobsList.innerHTML = `<div class="empty-message">You have no active jobs.</div>`;
            return;
        }

        jobs.forEach(job => {
            const price = job.price?.toFixed?.(2) || "0.00";

            const div = document.createElement("div");
            div.className = "job-card";

            div.innerHTML = `
                <div class="job-header">
                    <div class="job-title-block">
                        <div class="job-title">${job.title}</div>
                        <div class="job-client">Client: ${job.client_name}</div>
                        <div class="job-client"><b>Phone:</b> 
                            <a href="tel:${job.client_phone}" style="color:#81ecec">${job.client_phone}</a>
                        </div>
                    </div>
                    <div class="job-price">$${price}</div>
                </div>

                <div class="job-body">
                    <div class="job-row"><b>Address:</b> ${job.street}, ${job.city}, ${job.state} ${job.zipcode}</div>

                    <!-- MAPA -->
                    <iframe
                        width="100%"
                        height="180"
                        style="border:0; border-radius:12px; margin-top:8px;"
                        loading="lazy"
                        allowfullscreen
                        src="https://maps.google.com/maps?q=${encodeURIComponent(job.street + ', ' + job.city + ', ' + job.state + ' ' + job.zipcode)}&t=&z=15&ie=UTF8&iwloc=&output=embed">
                    </iframe>

                    <div class="job-row"><b>Payment:</b> ${job.payment_methods}</div>
                    <div class="job-row"><b>Details:</b> ${job.description}</div>
                    ${statusPill(job.status)}
                </div>

                <div class="job-footer" id="actions-${job.id}"></div>
            `;

            const actions = div.querySelector(`#actions-${job.id}`);

            const mapsBtn = document.createElement("button");
            mapsBtn.className = "action-btn-secondary";
            mapsBtn.textContent = "Open in Maps";
            mapsBtn.onclick = () => window.open(mapsLink(job), "_blank");
            actions.appendChild(mapsBtn);

            if (job.status === "accepted") {
                const btn = document.createElement("button");
                btn.className = "action-btn-main";
                btn.textContent = "Mark: On the Way";
                btn.onclick = () => updateStatus(job.id, "on_the_way");
                actions.appendChild(btn);
            }
            if (job.status === "on_the_way") {
                const btn = document.createElement("button");
                btn.className = "action-btn-main";
                btn.textContent = "Mark: Arrived";
                btn.onclick = () => updateStatus(job.id, "arrived");
                actions.appendChild(btn);
            }
            if (job.status === "arrived") {
                const btn = document.createElement("button");
                btn.className = "action-btn-main";
                btn.textContent = "Mark: Working";
                btn.onclick = () => updateStatus(job.id, "working");
                actions.appendChild(btn);
            }
            if (job.status === "working") {
                const btn = document.createElement("button");
                btn.className = "action-btn-main";
                btn.textContent = "Mark: Completed";
                btn.onclick = () => updateStatus(job.id, "complete");
                actions.appendChild(btn);
            }

            myJobsList.appendChild(div);
        });
    }

    /* ---------------------------
       LOAD COMPLETED JOBS
       + MAPA
    ----------------------------*/
    async function loadCompleted() {
        const { data: jobs } = await supabase
            .from("jobs")
            .select("*")
            .eq("worker_id", w.id)
            .eq("status", "complete")
            .order("created_at", { ascending: false });

        completedList.innerHTML = "";

        if (!jobs?.length) {
            completedList.innerHTML = `<div class="empty-message">No completed jobs.</div>`;
            return;
        }

        jobs.forEach(job => {
            const price = job.price?.toFixed?.(2) || "0.00";

            const div = document.createElement("div");
            div.className = "job-card";

            div.innerHTML = `
                <div class="job-header">
                    <div class="job-title">${job.title}</div>
                    <div class="job-price">$${price}</div>
                </div>

                <div class="job-body">
                    <div class="job-row"><b>Client:</b> ${job.client_name}</div>
                    <div class="job-row"><b>Phone:</b> ${job.client_phone}</div>
                    <div class="job-row"><b>Address:</b> ${job.street}, ${job.city}</div>

                    <!-- MAPA -->
                    <iframe
                        width="100%"
                        height="180"
                        style="border:0; border-radius:12px; margin-top:8px;"
                        loading="lazy"
                        allowfullscreen
                        src="https://maps.google.com/maps?q=${encodeURIComponent(job.street + ', ' + job.city)}&t=&z=15&ie=UTF8&iwloc=&output=embed">
                    </iframe>

                    ${statusPill("complete")}
                </div>
            `;

            completedList.appendChild(div);
        });
    }

    /* ---------------------------
       TABS
    ----------------------------*/
    function showAvailable() {
        tabAvailable.classList.add("tab-btn-active");
        tabMyJobs.classList.remove("tab-btn-active");
        tabCompleted.classList.remove("tab-btn-active");

        availableList.style.display = "block";
        myJobsList.style.display = "none";
        completedList.style.display = "none";
    }

    function showMyJobs() {
        tabMyJobs.classList.add("tab-btn-active");
        tabAvailable.classList.remove("tab-btn-active");
        tabCompleted.classList.remove("tab-btn-active");

        availableList.style.display = "none";
        myJobsList.style.display = "block";
        completedList.style.display = "none";
    }

    function showCompleted() {
        tabCompleted.classList.add("tab-btn-active");
        tabAvailable.classList.remove("tab-btn-active");
        tabMyJobs.classList.remove("tab-btn-active");

        availableList.style.display = "none";
        myJobsList.style.display = "none";
        completedList.style.display = "block";
    }

    tabAvailable.onclick = showAvailable;
    tabMyJobs.onclick = showMyJobs;
    tabCompleted.onclick = showCompleted;

    /* ---------------------------
       GO ONLINE
    ----------------------------*/
    btnGoOnline.onclick = async () => {
        await setWorkerOnlineState(true);
        updateOverlayAndFab();
        loadAll();
        showAvailable();
    };

    /* ---------------------------
       GO OFFLINE BUTTON
    ----------------------------*/
    fabOffline.onclick = async () => {
        const active = await getActiveJob();
        activeJobCache = active;

        dialogOverlay.style.display = "flex";

        if (!active) {
            dialogTitle.textContent = "Go Offline?";
            dialogText.textContent = "You will stop receiving new jobs.";
            dialogPrimary.textContent = "Yes, go offline";
            dialogDanger.style.display = "none";
            dialogGhost.textContent = "Cancel";

            dialogPrimary.onclick = async () => {
                await setWorkerOnlineState(false);
                updateOverlayAndFab();
                loadAll();
                dialogOverlay.style.display = "none";
            };

            dialogGhost.onclick = () => dialogOverlay.style.display = "none";

        } else {
            dialogTitle.textContent = "Active Job in Progress";
            dialogText.textContent = "Complete or cancel your current job to go offline.";
            dialogPrimary.textContent = "Go to My Job";
            dialogDanger.textContent = "Cancel Job";
            dialogDanger.style.display = "block";
            dialogGhost.textContent = "Stay Online";

            dialogPrimary.onclick = () => {
                showMyJobs();
                dialogOverlay.style.display = "none";
            };

            dialogDanger.onclick = async () => {
                await supabase.from("jobs").update({
                    worker_id: null,
                    worker_name: null,
                    worker_phone: null,
                    worker_photo: null,
                    status: "pending"
                }).eq("id", active.id);

                await setWorkerOnlineState(false);
                updateOverlayAndFab();
                loadAll();
                dialogOverlay.style.display = "none";
            };

            dialogGhost.onclick = () => dialogOverlay.style.display = "none";
        }
    };

    /* ---------------------------
       LOAD ALL
    ----------------------------*/
    async function loadAll() {
        await loadAvailable();
        await loadMyJobs();
        await loadCompleted();
        await updateOverlayAndFab();
    }

    await loadAll();
showAvailable();

/* ---------------------------------------
   REALTIME PARA WORKER
   Escucha cambios en trabajos en tiempo real
----------------------------------------*/
const workerRealtime = supabase
  .channel("jobs-realtime-worker")
  .on(
    "postgres_changes",
    {
      event: "*",
      schema: "public",
      table: "jobs"
    },
    async (payload) => {
      console.log("WORKER realtime update:", payload);

      // Refresca TODO automáticamente
      await loadAll();
    }
  )
  .subscribe();


    await loadAll();
    showAvailable();
});
</script>

</head>
<body>

<div class="header">
    <div class="brand">
        <div class="brand-logo">F</div>
        <div class="brand-txt">
            <div class="t1">FIXALL</div>
            <div class="t2">Worker Dashboard</div>
        </div>
    </div>
    <div class="worker-chip" id="workerNameChip">Worker</div>

</div>

<!-- FULLSCREEN STATUS OVERLAY -->
<div id="statusOverlay" class="status-overlay">
    <div class="status-card">
        <div class="status-badge">
            <span class="status-dot-big" style="background:#ff7675;"></span>
            <span id="overlayStatusText">You are currently OFFLINE</span>
        </div>
        <div class="status-title">Ready to work?</div>
        <div class="status-subtitle">
            Go online to start receiving FIXALL jobs nearby.
        </div>
        <div class="status-jobs" id="overlayJobsText">
            Checking available jobs...
        </div>
        <button id="btnGoOnline" class="status-btn">Go Online</button>
    </div>
</div>

<!-- GO OFFLINE DIALOG -->
<div id="dialogOverlay" class="dialog-overlay">
    <div class="dialog-card">
        <div class="dialog-title" id="dialogTitle">Go Offline?</div>
        <div class="dialog-text" id="dialogText">
            Are you sure you want to go offline?
        </div>
        <div class="dialog-actions">
            <button id="dialogPrimary" class="dialog-btn-primary">Yes</button>
            <button id="dialogDanger" class="dialog-btn-danger" style="display:none;">Cancel Job</button>
            <button id="dialogGhost" class="dialog-btn-ghost">Cancel</button>
        </div>
    </div>
</div>

<!-- TABS -->
<div class="tabs">
    <div id="tabAvailable" class="tab-btn tab-btn-active">Available</div>
    <div id="tabMyJobs" class="tab-btn">My Jobs</div>
    <div id="tabCompleted" class="tab-btn">Completed</div>
</div>

<div class="section-title">Available Jobs</div>
<div id="availableJobs"></div>

<div class="section-title">My Jobs</div>
<div id="myJobs" style="display:none;"></div>


<div class="section-title">Completed Jobs</div>
<div id="completedJobs" style="display:none;"></div>

<!-- FLOATING GO OFFLINE BUTTON -->
<button id="fabOffline" class="fab-offline">🔴 Go Offline</button>

<!-- NAV -->
<div class="bottom-nav">
    <a class="nav-btn nav-btn-active" href="/worker/dashboard.html">
        <span>🛠️</span>
        Jobs
    </a>
    <a class="nav-btn" href="/worker/profile.html">
        <span>👤</span>
        Profile
    </a>
    <a class="nav-btn" href="#" onclick="localStorage.removeItem('fixall_user'); location.href='/login.html';">
        <span>🚪</span>
        Logout
    </a>
</div>

</body>
</html>
